mit_joint_controller:
  joints:
    type: string_array
    description: "Names of the joints to control"

  control_mode:
    type: string
    default_value: "gravity"
    description: "Control mode: gravity, gravity_coriolis, gravity_velocity, gravity_impedance, or impedance_posvel"
    validation:
      one_of<>: [["gravity", "gravity_coriolis", "gravity_velocity", "gravity_impedance", "impedance_posvel"]]

  motor_kd:
    type: double_array
    default_value: [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
    description: "Motor Kd gains for velocity damping (0-5 for each joint)"
    validation:
      element_bounds<>: [0.0, 5.0]

  motor_kp:
    type: double_array
    default_value: [50.0, 50.0, 50.0, 50.0, 50.0, 50.0, 50.0]
    description: "Motor Kp gains for position control (0-500 for each joint)"
    validation:
      element_bounds<>: [0.0, 500.0]

  joint_stiffness:
    type: double_array
    default_value: [10.0, 10.0, 10.0, 10.0, 10.0, 10.0, 10.0]
    description: "Per-joint stiffness gains (Nm/rad). Used in impedance control modes."
    validation:
      element_bounds<>: [0.0, 500.0]

  joint_damping:
    type: double_array
    default_value: [-1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0]
    description: "Per-joint damping gains (Nms/rad). If negative, uses critical damping: 2*sqrt(stiffness). Used in impedance control modes."
    validation:
      element_bounds<>: [-1.0, 500.0]

  alpha:
    type: double
    default_value: 5.0
    description: "Velocity gain for computing desired joint velocities from position error in impedance_posvel mode. Higher values make the controller more aggressive."
    validation:
      bounds<>: [0.0, 10.0]

  dt_goal:
    type: double
    default_value: 0.01
    description: "Time step for computing goal position from goal velocity (seconds). Should be small since MIT mode runs at high frequency."
    validation:
      bounds<>: [0.001, 0.1]

  limit_commands:
    type: bool
    default_value: true
    description: "Whether to clip commands to joint limits"

  torque_safety_factor:
    type: double
    default_value: 1.0
    description: "Safety factor for torque limits (0.0-1.0)"
    validation:
      bounds<>: [0.0, 1.0]

  stop_commands:
    type: bool
    default_value: false
    description: "If true, stop sending commands to hardware (for debugging)"

  use_gravity_compensation:
    type: bool
    default_value: true
    description: "Add gravity compensation to feedforward torques"

  gravity_scale:
    type: double
    default_value: 1.0
    description: "Scale factor for gravity compensation torques. Use this to tune gravity compensation if URDF masses are not perfectly accurate."
    validation:
      bounds<>: [0.0, 2.0]

  use_position_command:
    type: bool
    default_value: true
    description: "Send position commands (q_goal) to motors. If false, q_goal will be set to current position."

  use_velocity_command:
    type: bool
    default_value: false
    description: "Send velocity commands (dq_goal) to motors. If false, dq_goal will be set to zero."

  dq_filter_alpha:
    type: double
    default_value: 0.3
    description: "Low-pass filter coefficient for velocity feedback (0.0-1.0). Lower values = more filtering. Set to 1.0 to disable filtering."
    validation:
      bounds<>: [0.0, 1.0]

  max_position_error:
    type: double
    default_value: 0.5
    description: "Maximum allowed position error per joint (radians). Errors larger than this will be clipped to prevent excessive torques."
    validation:
      bounds<>: [0.0, 3.14159]

  max_velocity:
    type: double
    default_value: 2.0
    description: "Maximum allowed velocity goal per joint (rad/s). Used in impedance_posvel mode when computing velocity from position error."
    validation:
      bounds<>: [0.0, 10.0]

  target_timeout:
    type: double
    default_value: 1.0
    description: "Timeout for target joint state messages (seconds). If no target received within this time, holds last target."
    validation:
      bounds<>: [0.1, 10.0]

  oscillation_detection:
    enabled:
      type: bool
      default_value: false
      description: "Enable oscillation detection and auto-stop"
    window:
      type: int
      default_value: 35
      description: "Number of samples to check for oscillation detection. At 350Hz control rate, 35 samples = 0.1 seconds"
      validation:
        bounds<>: [10, 500]
    frequency:
      type: double
      default_value: 2.0
      description: "Minimum oscillation frequency to detect (Hz)"
      validation:
        bounds<>: [0.5, 20.0]
    min_amplitude:
      type: double
      default_value: 0.05
      description: "Minimum peak-to-peak oscillation amplitude to detect (radians). Filters out small noise oscillations."
      validation:
        bounds<>: [0.0, 1.0]

  log:
    enabled:
      type: bool
      default_value: false
      description: "Enable debug logging"
    use_async_logging:
      type: bool
      default_value: true
      description: "If true, use asynchronous CSV logging in a background thread for better real-time performance. If false, use synchronous logging (may impact control loop timing)."
